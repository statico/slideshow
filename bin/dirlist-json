#!/usr/bin/env node
// Generated by CoffeeScript 1.10.0
(function() {
  var basedir, content, filename, filenames, fs, i, j, len, obj, path, stat, suffix;

  fs = require('fs');

  path = require('path');

  basedir = process.argv[2];

  if (!basedir) {
    console.error("usage: " + process.argv[1] + " <dir>");
    process.exit(1);
  }

  j = function(filename) {
    return path.join(basedir, filename);
  };

  filenames = fs.readdirSync(basedir);

  if (/back-in-the-day/.test(basedir)) {
    filenames.sort();
  } else {
    filenames.sort(function(a, b) {
      var at, bt;
      at = fs.statSync(j(a)).mtime.getTime();
      bt = fs.statSync(j(b)).mtime.getTime();
      return bt - at;
    });
  }

  obj = {
    paths: [],
    nonImages: []
  };

  for (i = 0, len = filenames.length; i < len; i++) {
    filename = filenames[i];
    if (/^\./.test(filename)) {
      continue;
    }
    if (filename === 'index.html' || filename === 'images.json') {
      continue;
    }
    if (/\.(jpe?g|gif|png|webm)$/.test(filename)) {
      obj.paths.push(filename);
    } else {
      stat = fs.statSync(j(filename));
      suffix = stat.isDirectory() ? '/' : '';
      obj.nonImages.push(filename + suffix);
    }
  }

  content = JSON.stringify(obj, null, '  ');

  fs.writeFileSync(j('images.json'), content);

}).call(this);
